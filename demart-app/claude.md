# DeMart 开发指南

## 项目概述

DeMart 是一个去中心化 C2C 交易平台，类似"闲鱼"模式。当前为 V1.0 Web2 原型阶段，专注于核心业务流程验证。

**产品定位**: 去中心化C2C闲置与服务交易平台
**一句话**: 通过聊天先沟通、再交易的C2C市场

## V1.0 开发重点

**核心策略**: Web2 功能原型优先
- ❌ 暂不集成 Web3 (钱包、智能合约)
- ✅ 模拟区块链交互（高保真模拟支付）
- ✅ 聊天为核心的 C2C 交易全流程

## 核心业务流程

```
商品详情 → 聊一聊 → 聊天协商 → 立即购买 → 模拟支付 → 订单管理 → 评价
```

**关键特性**:
- 聊天为中心的交易体验
- 卖家可在支付前修改价格
- 高保真模拟区块链支付流程

## 功能模块

### 1. 用户与身份
- **认证**: 邮箱密码注册登录 (NextAuth.js)
- **用户主页**: 昵称、头像、在售商品、评价
- **地址管理**: 多收货地址管理

### 2. 商品管理
- **发布商品**: 标题、描述、图片、价格(USDC计价)、分类
- **商品详情**: 主要"聊一聊"按钮，次要"直接购买"
- **浏览历史**: localStorage 实现，最多50条记录

### 3. 即时聊天 (核心)
- **发起聊天**: 商品详情页 → 聊天界面
- **实时消息**: WebSocket (Socket.io)
- **系统消息**: 价格修改等事件通知
- **关联商品栏**: 聊天中显示商品信息和购买按钮

### 4. 交易与支付
- **订单创建**: 从聊天或详情页发起
- **价格协商**: 卖家可在支付前修改价格
- **模拟支付**: 生成假交易哈希 → 延迟5-15秒 → 支付成功
- **订单状态**: `AWAITING_PAYMENT` → `PENDING_CONFIRMATION` → `PAYMENT_CONFIRMED` → `SHIPPED` → `COMPLETED`

### 5. 评价系统
- 交易完成后买卖双方互评
- 1-5星评分 + 文字评论

## 技术栈

| 层面 | 技术选择 | 说明 |
|------|---------|------|
| **前端** | Next.js + React | SSR/SSG 支持，SEO 友好 |
| **认证** | NextAuth.js | 成熟的认证解决方案 |
| **数据库** | PostgreSQL + Prisma | 类型安全 ORM，关系型数据库 |
| **实时通讯** | Socket.io | 成熟的 WebSocket 库 |
| **UI** | Tailwind CSS + Shadcn/ui | 原子化CSS + 高质量组件库 |
| **测试** | Jest + Testing Library | 单元测试 + 组件测试 |

## 设计系统 (简化)

### 主色调
- **Primary**: `#4A90E2` (科技蓝，信任感)
- **Accent**: `#50E3C2` (活力绿，成功状态)
- **Text**: `#1A202C` (深色文字)
- **Border**: `#E2E8F0` (边框分割线)

### 核心组件
- **按钮**: Primary, Secondary, Text 三种类型
- **商品卡片**: 图片 + 标题 + 价格 + 卖家信息
- **输入框**: 统一样式，Focus 状态高亮
- **聊天界面**: 实时消息 + 关联商品栏

## 开发规范

### 文件结构
```
src/
├── app/              # Next.js App Router
├── components/       # 可复用组件
│   ├── ui/          # 基础UI组件
│   ├── layout/      # 布局组件
│   └── feature/     # 功能组件
├── lib/             # 工具函数
└── types/           # TypeScript 类型定义
```

### 关键实现点

1. **聊天系统**
   - Socket.io 客户端/服务端
   - 消息实时同步
   - 离线消息存储

2. **模拟支付**
   - 生成假交易哈希: `0x[64位随机hex]`
   - 5-15秒随机延迟
   - 状态机更新

3. **浏览历史**
   - localStorage 存储
   - 最多50条记录
   - 自动清理旧记录

4. **价格协商**
   - WebSocket 实时通知
   - 订单状态检查
   - 系统消息插入

## 开发优先级

### P0 (最高优先级)
- [ ] 用户认证系统
- [ ] 商品CRUD
- [ ] 基础聊天功能
- [ ] 模拟支付流程

### P1 (高优先级)  
- [ ] 价格协商功能
- [ ] 订单管理
- [ ] 浏览历史
- [ ] 用户评价系统

### P2 (中优先级)
- [ ] 搜索功能
- [ ] 商品分类
- [ ] 消息推送
- [ ] 数据统计

## 测试策略

### 覆盖目标
- 单元测试: 80%+ 代码覆盖率
- 组件测试: 所有关键组件
- 集成测试: 关键业务流程

### 关键测试点
- [ ] 用户注册登录流程
- [ ] 商品发布和浏览
- [ ] 聊天消息发送接收
- [ ] 订单创建和支付模拟
- [ ] 浏览历史记录

## 部署与环境

### 环境变量
```bash
# 数据库
DATABASE_URL=postgresql://...

# NextAuth
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret

# Socket.io (生产环境)
SOCKET_URL=ws://your-domain
```

### 开发命令
```bash
npm run dev          # 开发服务器
npm run build        # 构建
npm run test         # 运行测试
npm run test:watch   # 监视模式测试
```

